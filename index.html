<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Emoji</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="normalize.css" />

    <!-- needs for emoji -->
    <link
      rel="modulepreload"
      href="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/picker.js"
    />
    <link
      rel="modulepreload"
      href="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/database.js"
    />
    <style></style>
  </head>
  <body>
    <!-- sort: true -->
    <div id="sortTrue" class="list-group">
      <!-- <div class="list-group-item">1</div>
      <div class="list-group-item">2</div>
      <div class="list-group-item">3</div>
      <div class="list-group-item">4</div>
      <div class="list-group-item">5</div>
      <div class="list-group-item">6</div> -->
    </div>

    <!-- sort: false -->
    <h1>drag to delete</h1>
    <div id="sortFalse" class="list-group delete">
      <!-- <div class="list-group-item">qux</div>
      <div class="list-group-item">quux</div> -->
    </div>

    <main>
      <div class="flex">
        <div>
          <!-- emoji picker keyboard -->
          <emoji-picker></emoji-picker>
        </div>
        <div>
          <div style="padding: 20px" role="alert" aria-live="polite">
            <pre style="display: none"></pre>
          </div>
          <div
            class="private-browsing-warning"
            style="padding: 20px; display: none; border: 2px dashed crimson"
            role="alert"
          >
            Note that <code>emoji-picker-element</code> does not support
            environments without IndexedDB. For polyfills and workarounds, see
            <a
              href="https://github.com/nolanlawson/emoji-picker-element/blob/master/README.md#environments-without-indexeddb"
            >
              the README </a
            >.
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.js"></script>
    <script src="script.js"></script>
    <script>
      const sortTrue = document.querySelector("#sortTrue");
      const sortFalse = document.querySelector("#sortFalse");

      // sort: true
      Sortable.create(sortTrue, {
        group: "sorting",
        sort: true,
      });

      // sort: false
      Sortable.create(sortFalse, {
        group: "sorting",
        sort: true,
      });
    </script>

    <!-- needs for emoji keyboard -->
    <script type="module">
      import "https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/picker.js";
      import "https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/database.js"; // avoid extra round-trip

      const $ = document.querySelector.bind(document);
      const $$ = (_) => Array.from(document.querySelectorAll(_));
      let customEmoji;

      // See https://stackoverflow.com/a/8533927
      function supportsSelector(selector) {
        const style = document.createElement("style");
        document.head.appendChild(style);
        try {
          style.sheet.insertRule(selector + "{}", 0);
        } catch (e) {
          return false;
        } finally {
          document.head.removeChild(style);
        }
        return true;
      }

      // check for private browsing mode to show the warning
      async function hasIDB() {
        if (typeof indexedDB === "undefined") {
          return false;
        }

        try {
          const idbFailed = await new Promise((resolve) => {
            const db = indexedDB.open("test-idb");
            db.onerror = () => resolve(true);
            db.onsuccess = () => {
              indexedDB.deleteDatabase("test-idb");
              resolve(false);
            };
          });
          if (idbFailed) {
            return false;
          }
        } catch (e) {
          return false;
        }
        return true;
      }

      async function loadCustomEmoji() {
        if (customEmoji) {
          return;
        }
        const categoriesToCustomEmoji = await (
          await fetch("./custom.json")
        ).json();
        customEmoji = [];
        for (const [category, names] of Object.entries(
          categoriesToCustomEmoji
        )) {
          for (const name of names) {
            customEmoji.push({
              category: category || undefined,
              name,
              shortcodes: [name],
              url: `./custom/${name}.svg`,
            });
          }
        }
      }

      const focusVisiblePolyfillPromise =
        !supportsSelector(":focus-visible") &&
        import(
          "https://cdn.jsdelivr.net/npm/focus-visible@^5/dist/focus-visible.js"
        );

      document.addEventListener("DOMContentLoaded", async () => {
        const picker = $("emoji-picker");
        const pre = $("pre");
        const onEvent = (e) => {
          console.log(e);
          pre.style.display = "block";
          pre.innerHTML = `Event: ${JSON.stringify(
            e.type
          )}\n\nData:\n\n${JSON.stringify(e.detail, null, 2)}`;
        };
        picker.addEventListener("emoji-click", onEvent);
        picker.addEventListener("skin-tone-change", onEvent);

        $$("input[name=darkmode]").forEach((input) => {
          input.addEventListener("change", (e) => {
            picker.classList.toggle("dark", e.target.value === "dark");
            picker.classList.toggle("light", e.target.value === "light");
          });
        });
        $("#custom").addEventListener("change", async (e) => {
          if (e.target.checked) {
            await loadCustomEmoji();
            picker.customEmoji = customEmoji;
          } else {
            picker.customEmoji = [];
          }
          picker.classList.toggle("has-custom", !!e.target.checked);
        });

        if (!(await hasIDB())) {
          $(".private-browsing-warning").style.display = "block";
        }

        if (focusVisiblePolyfillPromise) {
          await focusVisiblePolyfillPromise;
          applyFocusVisiblePolyfill(picker.shadowRoot);
        }
      });
    </script>
    <script>
      let emoj;

      document
        .querySelector("emoji-picker")
        .addEventListener("emoji-click", (event) => {
          console.log(event.detail.unicode);
          let li = document.createElement("div");
          li.innerHTML = `<div class="list-group-item">${event.detail.unicode}</div>`;
          document.querySelector("#sortTrue").append(li);
        });

      // let li = document.createElement("div");
      // li.innerHTML = `<div class="list-group-item">${event.detail.unicode}</div>`;
      // document.querySelector("#sortTrue").append(li);
    </script>
  </body>
</html>
